(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const h of o.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const y={mass:5e4,radius:5,vx:0,vy:0,fixed:!1,walls:!0,field:!1,collisions:!0,trail:!0},a={...y},r={mass:document.getElementById("mass"),radius:document.getElementById("radius"),vx:document.getElementById("vx"),vy:document.getElementById("vy"),count:document.getElementById("star-count"),frameRate:document.getElementById("frame-rate"),clearBtn:document.getElementById("clear-btn"),fixed:document.getElementById("fixed"),walls:document.getElementById("walls"),field:document.getElementById("field"),collisions:document.getElementById("collisions"),trail:document.getElementById("trail")},x=(n,t)=>{if(n==="fixed")a.fixed=t.checked;else if(n=="walls")a.walls=t.checked;else if(n=="collisions")a.collisions=t.checked;else if(n=="field")a.field=t.checked,a.field&&a.trail&&(a.trail=!1,r.trail.checked=!1);else if(n=="trail")a.trail=t.checked,a.trail&&a.field&&(f.fillStyle="#000",f.fillRect(0,0,m,g),a.field=!1,r.field.checked=!1);else{const e=parseFloat(t.value);isNaN(e)?t.classList.add("error"):(t.classList.remove("error"),a[n]=e)}},H=()=>{r.mass.value=y.mass.toString(),r.radius.value=y.radius.toString(),r.vx.value=y.vx.toString(),r.vy.value=y.vy.toString(),r.fixed.checked=y.fixed,r.walls.checked=y.walls,r.collisions.checked=y.collisions,r.field.checked=y.field,r.trail.checked=y.trail,r.mass.addEventListener("input",()=>x("mass",r.mass)),r.radius.addEventListener("input",()=>x("radius",r.radius)),r.vx.addEventListener("input",()=>x("vx",r.vx)),r.vy.addEventListener("input",()=>x("vy",r.vy)),r.fixed.addEventListener("change",()=>x("fixed",r.fixed)),r.walls.addEventListener("change",()=>{x("walls",r.walls),q()}),r.collisions.addEventListener("change",()=>x("collisions",r.collisions)),r.field.addEventListener("change",()=>{x("field",r.field)}),r.trail.addEventListener("change",()=>x("trail",r.trail)),r.clearBtn.addEventListener("click",()=>{f.fillStyle="#282828",f.fillRect(0,0,m,g),d.length=0,console.log("Clear requested")})},V=n=>{r.count&&(r.count.innerText=n.toString())},Y=n=>{r.frameRate&&(r.frameRate.innerText=n.toString())};class j{arrowImages;constructor(){this.arrowImages={black:new Image,green:new Image,blue:new Image,yellow:new Image,orange:new Image,red:new Image};let t=[];for(const[e,i]of Object.entries(this.arrowImages))i.src=`arrow_${e}.png`,t.push(i.decode().catch(s=>console.log(`${i.src} cannot be decoded`)));Promise.all(t)}getStrengthColor(t,e,i){t=Math.max(e,Math.min(t,i));const s=(t-e)/(i-e);return s<.01?"black":s<.05?"green":s<.3?"blue":s<.7?"yellow":s<.95?"orange":"red"}draw(t){for(let e=0;e<m;e+=20)for(let i=0;i<g;i+=20){let[s,o]=[0,0];for(const p of d){const[I,E]=p.getGravitationalFieldAt(e,i);s+=I,o+=E}const h=s*s+o*o,l=Math.sqrt(s*s+o*o),v=l==0?1:s/l,S=l==0?0:o/l,w=this.arrowImages[this.getStrengthColor(h,0,1e7)];t.setTransform(v,S,-S,v,e,i),t.drawImage(w,0,0,w.width,w.height,0,0,18,18),t.setTransform(1,0,0,1,0,0)}}}const z=100;function R(){const n=Math.random()*360,t=80+Math.random()*20,e=50+Math.random()*10;return`hsl(${n}, ${t}%, ${e}%)`}class u{x=0;y=0;constructor(t=0,e=0){this.x=t,this.y=e}add(t){return new u(this.x+t.x,this.y+t.y)}subtract(t){return new u(this.x-t.x,this.y-t.y)}scale(t){return new u(this.x*t,this.y*t)}dot(t){return this.x*t.x+this.y*t.y}component(t){return t=t.unit(),t.scale(this.dot(t))}resolve(t){t=t.unit();const e=this.component(t);return{perp:this.subtract(e),parallel:e}}unit(){const t=this.magnitude();return t==0?u.zero():new u(this.x/t,this.y/t)}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}static zero(){return new u(0,0)}}class K{MAX_VX=5e3;MAX_VY=5e3;x;y;color=R();vx=0;vy=0;mass=1e3;markedForDeletion=!1;radius=5;isFixed=!1;ax=0;ay=0;constructor(t,e){this.x=t,this.y=e}computeAcceleration(){[this.ax,this.ay]=[0,0];for(const t of d){if(t==this)continue;const[e,i]=t.getGravitationalFieldAt(this.x,this.y);this.ax+=e,this.ay+=i}}update(t){if(this.isFixed)return;this.vx+=this.ax*t,this.vy+=this.ay*t,this.vx=Math.max(-this.MAX_VX,Math.min(this.MAX_VX,this.vx)),this.vy=Math.max(-this.MAX_VY,Math.min(this.MAX_VY,this.vy));const e=T;for(const i of M)if(i.wallType==="left"){const s=i.x+i.width;this.x-this.radius<s&&(this.x=s+this.radius,this.vx=Math.abs(this.vx)*e)}else if(i.wallType==="right"){const s=i.x;this.x+this.radius>s&&(this.x=s-this.radius,this.vx=-Math.abs(this.vx)*e)}else if(i.wallType==="top"){const s=i.y+i.height;this.y-this.radius<s&&(this.y=s+this.radius,this.vy=Math.abs(this.vy)*e)}else if(i.wallType==="bottom"){const s=i.y;this.y+this.radius>s&&(this.y=s-this.radius,this.vy=-Math.abs(this.vy)*e)}this.x+=this.vx*t,this.y+=this.vy*t,this.markedForDeletion=this.x<-10*m||this.x>10*m||this.y<-10*g||this.y>10*g}draw(t){t.fillStyle=this.color,t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill()}getGravitationalFieldAt(t,e){const s=this.x-t,o=this.y-e,h=Math.sqrt(s*s+o*o+100);let l=z*this.mass/(h*h);return[l*s/h,l*o/h]}}function J(){for(let n=0;n<d.length;n++)for(let t=n+1;t<d.length;t++){const e=d[n],i=d[t];let s=new u(e.x,e.y),o=new u(i.x,i.y);const h=o.subtract(s).magnitude();if(h>=e.radius+i.radius)continue;const l=o.subtract(s).unit(),v=e.radius+i.radius-h;e.isFixed&&!i.isFixed?o=o.add(l.scale(v)):i.isFixed&&!e.isFixed?s=s.add(l.scale(-v)):(s=s.add(l.scale(-v/2)),o=o.add(l.scale(v/2))),[e.x,e.y]=[s.x,s.y],[i.x,i.y]=[o.x,o.y];const S=new u(e.vx,e.vy),w=new u(i.vx,i.vy);if(w.subtract(S).dot(l)<0)continue;const p=e.mass,I=i.mass,E=T,k=S.dot(l),C=w.dot(l),U=(k*(p-I*E)+I*C*(1+E))/(p+I),X=(C*(I-p*E)+p*k*(1+E))/(p+I),{perp:D}=S.resolve(l),{perp:N}=w.resolve(l),G=l.scale(U),$=l.scale(X),A=G.add(D),B=$.add(N);[e.vx,e.vy]=[A.x,A.y],[i.vx,i.vy]=[B.x,B.y]}}class c{static thickness=5;wallType;x;y;width;height;color=R();constructor(t){this.wallType=t,t=="left"?(this.x=0,this.y=0,this.width=c.thickness,this.height=g):t=="right"?(this.x=m-c.thickness,this.y=0,this.width=c.thickness,this.height=g):t=="top"?(this.x=c.thickness,this.y=0,this.width=m-2*c.thickness,this.height=c.thickness):(this.x=c.thickness,this.y=g-c.thickness,this.width=m-2*c.thickness,this.height=c.thickness)}update(){}draw(t){t.fillStyle=this.color,t.fillRect(this.x,this.y,this.width,this.height)}}const F=document.querySelector("#canvas"),f=F.getContext("2d"),m=window.innerWidth,g=window.innerHeight,T=.99;let d=[],M=[];const Q=new j;let L=0;const b={lastUpdateTime:0,frameCountSinceUpdate:0};Z();q();H();function Z(){F.addEventListener("click",n=>O(n.x,n.y)),F.addEventListener("mousemove",n=>{n.altKey&&O(n.x,n.y)}),F.width=m,F.height=g,requestAnimationFrame(P)}function q(){if(!a.walls){M.length=0;return}M.push(new c("left"),new c("right"),new c("top"),new c("bottom"))}function O(n,t){console.log("adding new star");const e=new K(n,t);e.mass=a.mass,e.radius=a.radius,e.isFixed=a.fixed,e.vx=a.vx,e.vy=a.vy,d.push(e)}function P(n){a.trail?f.fillStyle="rgba(40,40,40,0.08)":f.fillStyle="rgba(40,40,40,1)",f.fillRect(0,0,m,g),L==0&&(L=n),n-b.lastUpdateTime>=1e3&&(Y(b.frameCountSinceUpdate),b.frameCountSinceUpdate=0,b.lastUpdateTime=n),b.frameCountSinceUpdate++;const t=Math.min(n-L,30)/1e3;L=n;for(const e of d)e.computeAcceleration();for(const e of d)e.update(t);if(a.collisions)for(let e=0;e<4;e++)J();for(const e of d)e.draw(f);for(const e of M)e.draw(f);a.field&&Q.draw(f),f.font="20px monospace",f.fillStyle="white",d=d.filter(e=>!e.markedForDeletion),V(d.length),requestAnimationFrame(P)}
